<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›†åœ˜è¯çµ¡çª—å£è³‡è¨Šç¢ºèª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, getDocs, updateDoc, deleteDoc, writeBatch, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // ==========================================
        // âš ï¸ é‡è¦ï¼šFirebase è¨­å®š
        // ==========================================
        const myFirebaseConfig = {
            apiKey: "", 
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };
        // ==========================================

        let rawData = [];
        let userActions = {};
        let fieldOrder = []; 
        let currentUser = null;
        let adminCreds = { user: "admin", pass: "8888" }; 
        let pendingDeleteId = null;
        let db, auth, appId;

        window.isAdminLoggedIn = false;
        window.currentAdminFilter = 'all';

        async function startSystem() {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : myFirebaseConfig;
                appId = typeof __app_id !== 'undefined' ? __app_id : "group-survey-app"; 

                if (!firebaseConfig.apiKey) {
                    console.error("Firebase æœªé…ç½®");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        await loadConfig();
                        listenToData();
                    }
                });
            } catch (err) { console.error("Init Error:", err); }
        }

        async function loadConfig() {
            if (!currentUser) return;
            try {
                const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'admin_config', 'settings');
                const configDoc = await getDoc(configRef);
                if (configDoc.exists()) {
                    adminCreds = configDoc.data();
                }
            } catch(e) { console.error("Config Load Error:", e); }
        }

        function listenToData() {
            if (!currentUser) return;
            
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'raw_list'), (snap) => {
                rawData = snap.docs.map(d => ({ ...d.data(), _rowId: d.id }));
                if (rawData.length > 0) {
                    fieldOrder = rawData[0]._fieldOrder || Object.keys(rawData[0]).filter(k => !k.startsWith('_'));
                }
                updateUIOnDataChange();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'user_actions'), (snap) => {
                userActions = {};
                snap.forEach(d => { userActions[d.id] = d.data(); });
                updateUIOnDataChange();
            });
        }

        function updateUIOnDataChange() {
            const taxId = document.getElementById('user-tax-id')?.value.trim();
            if (taxId) window.userSearch(true); 
            if (window.isAdminLoggedIn) window.refreshAdminTable();
        }

        window.switchTab = (tab) => {
            document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden'));
            if (tab === 'user') {
                document.getElementById('section-user').classList.remove('hidden');
            } else {
                if (window.isAdminLoggedIn) {
                    document.getElementById('section-admin').classList.remove('hidden');
                    window.refreshAdminTable();
                } else {
                    document.getElementById('section-admin-login').classList.remove('hidden');
                }
            }
            document.getElementById('tab-user').className = tab === 'user' ? 'px-4 py-2 font-bold text-orange-600 border-b-2 border-orange-500' : 'px-4 py-2 font-bold text-stone-400 hover:text-orange-500';
            document.getElementById('tab-admin').className = tab === 'admin' ? 'px-4 py-2 font-bold text-orange-600 border-b-2 border-orange-500' : 'px-4 py-2 font-bold text-stone-400 hover:text-orange-500';
        };

        window.userSearch = (isSilent = false) => {
            const taxId = document.getElementById('user-tax-id').value.trim();
            const container = document.getElementById('user-result-container');
            const submitArea = document.getElementById('final-submit-area');
            const addBtnArea = document.getElementById('add-contact-area');
            if (!taxId) return;

            const matches = rawData.filter(item => String(findTaxId(item)) === taxId && userActions[item._rowId]?.status !== 'deleted');
            const newContacts = Object.keys(userActions)
                .filter(id => {
                    const act = userActions[id];
                    return id.startsWith('new-') && act.status !== 'deleted' && String(findTaxId(act.data)) === taxId;
                })
                .map(id => ({ ...userActions[id].data, _rowId: id }));

            const finalDisplayList = [...matches, ...newContacts];

            if (finalDisplayList.length === 0) {
                if(!isSilent) {
                    container.innerHTML = '';
                    submitArea?.classList.add('hidden');
                    addBtnArea?.classList.add('hidden');
                    window.showModal('æŸ¥ç„¡è³‡æ–™', 'æ‰¾ä¸åˆ°æ­¤çµ±ç·¨ã€‚', 'error');
                }
                return;
            }

            container.innerHTML = '';
            finalDisplayList.forEach((person, index) => {
                const rowId = person._rowId;
                const action = userActions[rowId];
                const currentData = action ? action.data : person;
                
                let sText = 'å¾…è™•ç†';
                if (action?.status === 'confirmed') {
                    // æª¢æŸ¥è³‡æ–™æ˜¯å¦æœ‰è¢«ä¿®æ”¹éï¼Œé¡¯ç¤ºä¸åŒçš„æ¨™ç±¤
                    const isModified = action.status === 'modified' || (action.original && JSON.stringify(action.data) !== JSON.stringify(action.original));
                    sText = isModified ? 'å·²ä¿®æ”¹' : 'å·²ç¢ºèª';
                }
                else if (action?.status === 'modified') sText = 'å·²ä¿®æ”¹';
                else if (rowId.startsWith('new-')) sText = 'å…¨æ–°æ–°å¢';

                let sClass = (action?.status === 'confirmed') ? 'status-confirmed' : (action?.status === 'modified' ? 'status-modified' : 'status-none');
                let cClass = (action?.status === 'confirmed') ? 'card-confirmed' : (action?.status === 'modified' ? 'card-modified' : 'bg-white');
                
                const displayKeys = [...new Set([...fieldOrder, ...Object.keys(currentData)])].filter(k => !k.startsWith('_') && k !== 'undefined' && k !== 'æœ€å¾Œç•°å‹•æ™‚é–“' && k !== 'è™•ç†ç‹€æ…‹');
                
                const card = document.createElement('div');
                card.className = `${cClass} rounded-2xl shadow-sm border-2 border-orange-100 overflow-hidden mb-6 transition-all`;
                card.innerHTML = `
                    <div class="p-5 border-b border-orange-100 flex justify-between items-center bg-orange-50/50">
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 bg-orange-500 text-white rounded-full flex items-center justify-center font-bold text-sm shadow-sm">${index + 1}</span>
                            <span class="font-bold text-stone-800 text-lg">${findContactName(currentData)}</span>
                        </div>
                        <span class="status-badge ${sClass}">${sText}</span>
                    </div>
                    <div class="p-0 overflow-x-auto">
                        <table class="w-full text-sm">
                            <tbody>
                                ${displayKeys.map(key => `
                                    <tr class="border-b border-orange-50 last:border-0 hover:bg-orange-50/30">
                                        <td class="p-3 w-1/3 bg-orange-50/30 font-bold text-stone-500 border-r border-orange-100">${key}</td>
                                        <td class="p-3 w-2/3">
                                            <span id="view-${rowId}-${key}">${currentData[key] || ''}</span>
                                            <input id="edit-${rowId}-${key}" type="text" value="${currentData[key] || ''}" class="hidden w-full border border-orange-200 rounded px-2 py-1 focus:ring-2 focus:ring-orange-300">
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 bg-orange-50/30 flex justify-between items-center border-t border-orange-100">
                        <button onclick="window.requestDelete('${rowId}')" class="px-3 py-2 text-red-500 hover:bg-red-50 rounded-lg text-xs font-bold">åˆªé™¤</button>
                        <div class="flex gap-2">
                            <button onclick="window.confirmRow('${rowId}')" class="px-4 py-2 bg-green-600 text-white rounded font-bold text-sm shadow-md hover:bg-green-700">ç¢ºèªæ­£ç¢º</button>
                            <button id="btn-edit-${rowId}" onclick="window.startEditRow('${rowId}')" class="px-4 py-2 bg-white border border-orange-200 text-stone-600 rounded text-sm shadow-sm hover:bg-orange-50">ä¿®æ”¹</button>
                            <button id="btn-save-${rowId}" onclick="window.saveRow('${rowId}')" class="hidden px-4 py-2 bg-orange-500 text-white rounded font-bold text-sm shadow-md hover:bg-orange-600">å„²å­˜</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            submitArea?.classList.remove('hidden');
            addBtnArea?.classList.remove('hidden');
        };

        window.openAddContact = () => {
            const taxId = document.getElementById('user-tax-id').value.trim();
            // å°‹æ‰¾åŸºæº–è³‡æ–™ä¾†æŠ“å–å…¬å¸åç¨±å’Œåœ°å€
            let base = rawData.find(item => String(findTaxId(item)) === taxId && userActions[item._rowId]?.status !== 'deleted');
            if (!base) {
                const anyNew = Object.values(userActions).find(a => a.status !== 'deleted' && String(findTaxId(a.data)) === taxId);
                if (anyNew) base = anyNew.data;
            }
            if(!base) return;

            const modal = document.getElementById('add-contact-modal');
            const formContainer = document.getElementById('add-contact-form-container');
            formContainer.innerHTML = '';
            const keys = [...new Set([...fieldOrder, ...Object.keys(base)])].filter(k => !k.startsWith('_') && k !== 'undefined');
            
            keys.forEach(key => {
                // è‡ªå‹•å¸¶å…¥é‚è¼¯ï¼šåªè¦æ¬„ä½åç¨±åŒ…å« çµ±ç·¨ã€åç¨±ã€åœ°å€ ç›¸é—œå­—çœ¼ï¼Œå³è‡ªå‹•å¸¶å…¥ä¸”å”¯è®€
                const isAutoFill = key.includes('çµ±ä¸€ç·¨è™Ÿ') || key.includes('çµ±ç·¨') || key.includes('åç¨±') || key.includes('å…¬å¸') || key.includes('åœ°å€');
                const val = isAutoFill ? (base[key] || '') : '';
                
                const div = document.createElement('div');
                div.className = "mb-3";
                div.innerHTML = `
                    <label class="block text-xs font-bold text-stone-500 mb-1">${key}</label>
                    <input type="text" data-key="${key}" value="${val}" 
                        ${isAutoFill ? 'readonly class="w-full bg-orange-100 p-2 rounded text-sm border-0 text-stone-500 cursor-not-allowed"' : 'class="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-orange-300 outline-none" placeholder="è«‹è¼¸å…¥..."'}>
                `;
                formContainer.appendChild(div);
            });
            modal.classList.remove('hidden');
        };

        window.submitNewContact = async () => {
            if (!currentUser) return;
            const inputs = document.querySelectorAll('#add-contact-form-container input');
            const newData = {};
            inputs.forEach(input => { newData[input.getAttribute('data-key')] = input.value; });
            const rowId = `new-${Date.now()}`;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'user_actions', rowId), {
                status: 'new', data: newData, original: {}, timestamp: new Date().toLocaleString()
            });
            document.getElementById('add-contact-modal').classList.add('hidden');
        };

        window.saveRow = async (rowId) => {
            if (!currentUser) return;
            const action = userActions[rowId];
            const item = rawData.find(r => r._rowId === rowId);
            const original = item || action?.original || {};
            const newData = {};
            const inputs = document.querySelectorAll(`input[id^="edit-${rowId}-"]`);
            
            inputs.forEach(input => { 
                const key = input.id.replace(`edit-${rowId}-`, '');
                newData[key] = input.value; 
            });
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'user_actions', rowId), {
                status: (rowId.startsWith('new-') ? 'new' : 'modified'), 
                data: newData, 
                original: original, 
                timestamp: new Date().toLocaleString()
            });
            
            // å„²å­˜å¾Œåˆ‡æ›å›æª¢è¦–æ¨¡å¼
            Object.keys(newData).forEach(k => {
                const viewEl = document.getElementById(`view-${rowId}-${k}`);
                const editEl = document.getElementById(`edit-${rowId}-${k}`);
                if(viewEl) viewEl.classList.remove('hidden');
                if(editEl) editEl.classList.add('hidden');
            });
            document.getElementById(`btn-edit-${rowId}`)?.classList.remove('hidden');
            document.getElementById(`btn-save-${rowId}`)?.classList.add('hidden');
        };

        window.confirmRow = async (rowId) => {
            if (!currentUser) return;
            
            // æª¢æ ¸ï¼šå¦‚æœè©²åˆ—çš„ç·¨è¼¯æ¡†æ˜¯é¡¯ç¤ºç‹€æ…‹ï¼Œä»£è¡¨ä½¿ç”¨è€…ä¿®æ”¹äº†ä½†æ²’å­˜
            const firstEditInput = document.querySelector(`input[id^="edit-${rowId}-"]`);
            if (firstEditInput && !firstEditInput.classList.contains('hidden')) {
                window.showModal('è«‹å…ˆå„²å­˜', 'æ‚¨å·²é€²è¡Œä¿®æ”¹ï¼Œè«‹å…ˆé»é¸ã€Œå„²å­˜ã€æŒ‰éˆ•ç¢ºèªå…§å®¹å¾Œï¼Œæ‰èƒ½é»é¸ã€Œç¢ºèªæ­£ç¢ºã€ã€‚', 'error');
                return;
            }

            const item = rawData.find(r => r._rowId === rowId);
            const current = userActions[rowId]?.data || item || {};
            const original = item || userActions[rowId]?.original || {};
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'user_actions', rowId), {
                status: 'confirmed', data: current, original: original, timestamp: new Date().toLocaleString()
            });
        };

        window.finalSubmitSurvey = () => {
            const taxId = document.getElementById('user-tax-id').value.trim();
            if(!taxId) return;

            const matches = rawData.filter(item => String(findTaxId(item)) === taxId && userActions[item._rowId]?.status !== 'deleted');
            const newContacts = Object.keys(userActions)
                .filter(id => {
                    const act = userActions[id];
                    return id.startsWith('new-') && act.status !== 'deleted' && String(findTaxId(act.data)) === taxId;
                });

            const allContactIds = [...matches.map(m => m._rowId), ...newContacts];
            const allConfirmed = allContactIds.every(id => userActions[id]?.status === 'confirmed');

            if (!allConfirmed) {
                window.showModal('æç¤º', 'è«‹å…ˆç¢ºä¿æ‰€æœ‰è¯çµ¡äººå‡å·²é»é¸ã€Œç¢ºèªæ­£ç¢ºã€ã€‚è‹¥æœ‰ä¿®æ”¹å…§å®¹ï¼Œè«‹è¨˜å¾—å…ˆæŒ‰ã€Œå„²å­˜ã€å†æŒ‰ã€Œç¢ºèªã€ã€‚', 'error');
                return;
            }

            window.showModal('å·²å®Œæˆ', 'æ„Ÿè¬æ‚¨çš„ç¢ºèªï¼Œè³‡æ–™å·²å³æ™‚å­˜å…¥é›²ç«¯ä¸¦æ›´æ–°æŸ¥æ ¸é€²åº¦ã€‚', 'success');
        };

        window.startEditRow = (rowId) => {
            const item = userActions[rowId]?.data || rawData.find(r => r._rowId === rowId);
            Object.keys(item).filter(k => !k.startsWith('_')).forEach(k => {
                document.getElementById(`view-${rowId}-${k}`)?.classList.add('hidden');
                document.getElementById(`edit-${rowId}-${k}`)?.classList.remove('hidden');
            });
            document.getElementById(`btn-edit-${rowId}`).classList.add('hidden');
            document.getElementById(`btn-save-${rowId}`).classList.remove('hidden');
        };

        window.attemptLogin = () => {
            const u = document.getElementById('admin-user').value;
            const p = document.getElementById('admin-pass').value;
            if (u === adminCreds.user && p === adminCreds.pass) {
                window.isAdminLoggedIn = true;
                window.switchTab('admin');
            } else {
                window.showModal('éŒ¯èª¤', 'å¸³è™Ÿæˆ–å¯†ç¢¼ä¸æ­£ç¢º', 'error');
            }
        };

        window.confirmDeleteAction = async () => {
            if (!pendingDeleteId || !currentUser) return;
            const rowId = pendingDeleteId;
            document.getElementById('delete-confirm-modal').classList.add('hidden');
            const original = rawData.find(r => r._rowId === rowId) || userActions[rowId]?.original || {};
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'user_actions', rowId), {
                status: 'deleted', data: original, original: original, timestamp: new Date().toLocaleString()
            });
            pendingDeleteId = null;
        };

        window.requestDelete = (rowId) => {
            pendingDeleteId = rowId;
            document.getElementById('delete-confirm-modal').classList.remove('hidden');
        };

        window.exportToExcel = () => {
            const exportData = [];
            
            // è™•ç†åŸå§‹åå–®ä¸­çš„è³‡æ–™
            rawData.forEach(item => {
                const action = userActions[item._rowId];
                let final = item, st = 'æœªè™•ç†';
                
                if (action) {
                    if (action.status === 'deleted') {
                        st = 'å·²åˆªé™¤';
                    } else {
                        final = action.data;
                        // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œå·²ä¿®æ”¹ã€ï¼šå¦‚æœç‹€æ…‹æ˜¯ modifiedï¼Œæˆ–è€…ç›®å‰è³‡æ–™èˆ‡åŸå§‹è³‡æ–™å­—ä¸²ä¸ç¬¦ï¼Œå‰‡é¡¯ç¤ºå·²ä¿®æ”¹
                        const isModified = (action.status === 'modified' || (action.original && JSON.stringify(action.data) !== JSON.stringify(action.original)));
                        
                        if (action.status === 'confirmed') {
                            st = isModified ? 'å·²ä¿®æ”¹' : 'å·²ç¢ºèª';
                        } else {
                            st = isModified ? 'å·²ä¿®æ”¹' : 'æŸ¥æ ¸ä¸­';
                        }
                    }
                }
                const row = {};
                fieldOrder.forEach(k => row[k] = final[k] !== undefined ? final[k] : "");
                row["è™•ç†ç‹€æ…‹"] = st; 
                row["æœ€å¾Œç•°å‹•æ™‚é–“"] = action ? action.timestamp : "";
                exportData.push(row);
            });

            // è™•ç†å…¨æ–°æ–°å¢çš„è¯çµ¡äºº
            Object.keys(userActions).filter(id => id.startsWith('new-')).forEach(id => {
                const a = userActions[id];
                if (a.status === 'deleted') return;
                const row = {};
                fieldOrder.forEach(k => row[k] = a.data[k] !== undefined ? a.data[k] : "");
                
                // æ–°å¢çš„è¯çµ¡äººåŒ¯å‡ºæ™‚æ¨™è¨»ç‚º å…¨æ–°æ–°å¢ æˆ– æ–°å¢(å·²ç¢ºèª)
                row["è™•ç†ç‹€æ…‹"] = a.status === 'confirmed' ? "æ–°å¢(å·²ç¢ºèª)" : "å…¨æ–°æ–°å¢"; 
                row["æœ€å¾Œç•°å‹•æ™‚é–“"] = a.timestamp;
                exportData.push(row);
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "æŸ¥æ ¸çµæœ");
            XLSX.writeFile(wb, `æŸ¥æ ¸çµæœ.xlsx`);
        };

        window.handleFileUpload = async (e) => {
            if (!currentUser) return;
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async (evt) => {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                const ws = workbook.Sheets[workbook.SheetNames[0]];
                const range = XLSX.utils.decode_range(ws['!ref']);
                const headers = [];
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const addr = XLSX.utils.encode_col(C) + "1";
                    if(ws[addr]) headers.push(ws[addr].v);
                }
                window.showModal('è™•ç†ä¸­', `å°å…¥ ${json.length} ç­†...`, 'loading');
                for (let i = 0; i < json.length; i++) {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'raw_list', `row-${Date.now()}-${i}`), { ...json[i], _fieldOrder: headers });
                }
                window.showModal('æˆåŠŸ', `å°å…¥å®Œæˆ`, 'success');
            };
            reader.readAsArrayBuffer(file);
        };

        window.confirmClearData = async () => {
            if (!window.confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿ") || !currentUser) return;
            window.showModal('è™•ç†ä¸­', 'æ­£åœ¨æ¸…ç©ºè³‡æ–™...', 'loading');
            const rawSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'raw_list'));
            const actionSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'user_actions'));
            const deleteDocs = async (snap) => {
                let batch = writeBatch(db), count = 0;
                for (const d of snap.docs) {
                    batch.delete(d.ref); count++;
                    if (count === 400) { await batch.commit(); batch = writeBatch(db); count = 0; }
                }
                if (count > 0) await batch.commit();
            };
            await deleteDocs(rawSnap); await deleteDocs(actionSnap);
            window.showModal('æˆåŠŸ', 'è³‡æ–™å·²æ¸…é™¤ã€‚', 'success');
        };

        window.setAdminFilter = (val) => {
            window.currentAdminFilter = val;
            window.refreshAdminTable();
        };

        window.refreshAdminTable = () => {
            const tbody = document.getElementById('admin-status-table');
            if(!tbody) return; 
            tbody.innerHTML = '';
            
            const groupsMap = {};
            rawData.forEach(item => {
                const tid = String(findTaxId(item));
                if(!groupsMap[tid]) groupsMap[tid] = { taxId: tid, name: findName(item), count: 0, completed: 0 };
                const action = userActions[item._rowId];
                if (action?.status === 'deleted') return;
                groupsMap[tid].count++; 
                if(action?.status === 'confirmed') groupsMap[tid].completed++;
            });
            Object.keys(userActions).filter(id => id.startsWith('new-')).forEach(id => {
                const a = userActions[id];
                if (a.status === 'deleted') return;
                const tid = String(findTaxId(a.data));
                if(!groupsMap[tid]) groupsMap[tid] = { taxId: tid, name: findName(a.data), count: 0, completed: 0 };
                groupsMap[tid].count++; 
                if(a.status === 'confirmed') groupsMap[tid].completed++;
            });

            const filteredData = Object.values(groupsMap).filter(g => {
                const isDone = g.completed === g.count && g.count > 0;
                if (window.currentAdminFilter === 'done') return isDone;
                if (window.currentAdminFilter === 'pending') return !isDone;
                return true;
            });

            filteredData.sort((a,b)=>a.taxId.localeCompare(b.taxId)).forEach(g => {
                const tr = document.createElement('tr');
                let isDone = g.completed === g.count && g.count > 0;
                tr.className = "hover:bg-stone-50 transition-colors";
                tr.innerHTML = `
                    <td class="p-4 font-mono text-xs border-b">${g.taxId}</td>
                    <td class="p-4 text-xs border-b font-medium">${g.name}</td>
                    <td class="p-4 text-center text-xs font-bold text-orange-600 border-b">${g.completed} / ${g.count}</td>
                    <td class="p-4 border-b"><span class="status-badge ${isDone ? 'status-confirmed' : 'status-modified'}">${isDone ? 'å·²å®Œæˆ' : 'æŸ¥æ ¸ä¸­'}</span></td>
                `;
                tbody.appendChild(tr);
            });
        };

        function findTaxId(obj) { return obj[Object.keys(obj).find(k => k.includes('çµ±ä¸€ç·¨è™Ÿ') || k.includes('çµ±ç·¨'))] || ''; }
        function findName(obj) { return obj[Object.keys(obj).find(k => k.includes('åç¨±') || k.includes('å…¬å¸'))] || ''; }
        function findContactName(obj) { return obj[Object.keys(obj).find(k => k.includes('è¯çµ¡äºº') || k.includes('å§“å'))] || 'è¯çµ¡çª—å£'; }
        
        window.closeModal = () => document.getElementById('custom-modal').classList.add('hidden');
        window.closeAddModal = () => document.getElementById('add-contact-modal').classList.add('hidden');
        window.closeDeleteModal = () => document.getElementById('delete-confirm-modal').classList.add('hidden');
        window.showModal = (title, text, type) => {
            const m = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').textContent = text;
            const iconWrap = document.getElementById('modal-icon');
            iconWrap.innerHTML = type === 'loading' ? '<span class="animate-spin inline-block w-8 h-8 border-4 border-orange-500 border-t-transparent rounded-full"></span>' : (type === 'success' ? 'âœ…' : 'âŒ');
            m.classList.remove('hidden');
        };

        window.onload = startSystem;
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #fffaf5; }
        .status-badge { padding: 4px 10px; border-radius: 99px; font-size: 11px; font-weight: bold; white-space: nowrap; }
        .status-none { background: #fed7aa; color: #9a3412; }
        .status-confirmed { background: #bbf7d0; color: #166534; }
        .status-modified { background: #fde047; color: #854d0e; }
        .card-confirmed { background-color: #f0fdf4 !important; }
        .card-modified { background-color: #fefce8 !important; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #ed8936; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen pb-20 text-stone-800">
    <nav class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50 border-b border-orange-100 h-20">
        <div class="max-w-6xl mx-auto px-4 h-full flex items-center justify-between">
            <h1 class="font-bold text-2xl text-orange-900 tracking-tight">é›†åœ˜è¯çµ¡çª—å£è³‡è¨Šç¢ºèª</h1>
            <div class="flex bg-stone-100 p-1 rounded-xl">
                <button onclick="switchTab('user')" id="tab-user" class="px-6 py-2 rounded-lg font-bold text-orange-600 bg-white shadow-sm transition-all">æŸ¥æ ¸ä»‹é¢</button>
                <button onclick="switchTab('admin')" id="tab-admin" class="px-6 py-2 rounded-lg font-bold text-stone-400 hover:text-orange-500 transition-all">å¾Œå°ç®¡ç†</button>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-10">
        <!-- ä½¿ç”¨è€…ä»‹é¢ -->
        <div id="section-user">
            <div class="bg-white rounded-2xl shadow-lg p-10 mb-8 text-center border border-orange-100">
                <h2 class="text-xl font-bold mb-6 text-stone-600">è«‹è¼¸å…¥å…¬å¸çµ±ä¸€ç·¨è™Ÿé–‹å§‹æŸ¥æ ¸</h2>
                <div class="flex gap-3 max-w-md mx-auto">
                    <input type="text" id="user-tax-id" maxlength="8" class="flex-1 border-2 border-orange-100 p-4 rounded-2xl text-center font-mono text-2xl focus:border-orange-500 outline-none transition-all" placeholder="8ä½çµ±ç·¨">
                    <button onclick="userSearch()" class="bg-orange-500 text-white px-8 rounded-2xl font-bold hover:bg-orange-600 shadow-lg shadow-orange-200 transition-all">æŸ¥è©¢</button>
                </div>
            </div>
            <div id="user-result-container"></div>
            <div id="add-contact-area" class="hidden text-center mb-8">
                <button onclick="openAddContact()" class="bg-white border-2 border-dashed border-orange-300 text-orange-600 px-8 py-4 rounded-2xl font-bold hover:bg-orange-50 transition-all shadow-sm">+ æ–°å¢è¯çµ¡çª—å£</button>
            </div>
            <div id="final-submit-area" class="hidden text-center">
                <button onclick="finalSubmitSurvey()" class="bg-orange-500 text-white px-12 py-4 rounded-full font-bold shadow-xl hover:scale-105 transition-transform">ç¢ºèªç„¡èª¤ä¸¦æäº¤</button>
            </div>
        </div>

        <!-- ç®¡ç†ç™»å…¥ -->
        <div id="section-admin-login" class="hidden max-w-sm mx-auto mt-20 p-10 bg-white rounded-3xl shadow-2xl border border-orange-50">
            <div class="text-center mb-8">
                <div class="inline-block p-4 bg-orange-100 rounded-2xl mb-4 text-3xl">ğŸ”‘</div>
                <h3 class="font-bold text-2xl">ç®¡ç†å“¡ç™»å…¥</h3>
            </div>
            <input type="text" id="admin-user" placeholder="å¸³è™Ÿ" class="w-full border p-4 rounded-xl mb-4 focus:ring-2 focus:ring-orange-300 outline-none">
            <input type="password" id="admin-pass" placeholder="å¯†ç¢¼" class="w-full border p-4 rounded-xl mb-6 focus:ring-2 focus:ring-orange-300 outline-none">
            <button onclick="attemptLogin()" class="w-full bg-stone-800 text-white py-4 rounded-xl font-bold hover:bg-stone-900 transition-all shadow-lg">é€²å…¥ç®¡ç†ç³»çµ±</button>
        </div>

        <!-- å¾Œå°ä»‹é¢ -->
        <div id="section-admin" class="hidden">
            <div class="flex flex-col lg:flex-row gap-8">
                <aside class="lg:w-1/4 space-y-6">
                    <div class="bg-white p-6 rounded-2xl border border-orange-100 shadow-sm">
                        <h3 class="font-bold mb-4 text-stone-500 text-sm flex items-center gap-2">
                            <span class="w-2 h-2 bg-orange-500 rounded-full"></span>æ•¸æ“šå·¥å…·
                        </h3>
                        <input type="file" id="up-in" class="hidden" onchange="handleFileUpload(event)">
                        <button onclick="document.getElementById('up-in').click()" class="w-full bg-orange-500 text-white py-3 rounded-xl font-bold mb-3 hover:bg-orange-600 transition-colors shadow-sm">å°å…¥åŸå§‹è³‡æ–™ (Excel)</button>
                        <button onclick="exportToExcel()" class="w-full bg-stone-100 text-stone-700 py-3 rounded-xl font-bold mb-6 hover:bg-stone-200 transition-colors">åŒ¯å‡ºæŸ¥æ ¸çµæœ (Excel)</button>
                        <hr class="mb-6">
                        <button onclick="confirmClearData()" class="w-full text-red-400 text-xs hover:text-red-600 font-medium transition-colors">âš ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
                    </div>
                </aside>

                <section class="lg:w-3/4">
                    <div class="bg-white rounded-3xl border border-orange-100 shadow-sm overflow-hidden">
                        <div class="p-6 bg-stone-50/50 border-b flex flex-col sm:flex-row justify-between items-center gap-4">
                            <h3 class="font-bold text-lg text-stone-700">å„å…¬å¸é€²åº¦ç›£æ§</h3>
                            <div class="flex items-center gap-3">
                                <span class="text-xs font-bold text-stone-400">ç‹€æ…‹ç¯©é¸</span>
                                <select onchange="setAdminFilter(this.value)" class="text-sm border-2 border-stone-200 rounded-xl px-4 py-2 bg-white focus:border-orange-500 outline-none transition-all">
                                    <option value="all">å…¨éƒ¨é€²åº¦</option>
                                    <option value="pending">æŸ¥æ ¸ä¸­ (æœªå®Œæˆ)</option>
                                    <option value="done">å·²å®Œæˆ (å…¨æ•¸ç¢ºèª)</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-stone-50 text-stone-400 uppercase tracking-wider">
                                    <tr>
                                        <th class="p-4 font-bold border-b">çµ±ä¸€ç·¨è™Ÿ</th>
                                        <th class="p-4 font-bold border-b">å…¬å¸åç¨±</th>
                                        <th class="p-4 text-center font-bold border-b">é€²åº¦</th>
                                        <th class="p-4 font-bold border-b">ç‹€æ…‹</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-status-table" class="divide-y divide-stone-100"></tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="custom-modal" class="fixed inset-0 bg-stone-900/40 z-[300] hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white rounded-3xl max-w-xs w-full p-8 text-center shadow-2xl scale-in">
            <div id="modal-icon" class="text-5xl mb-4"></div>
            <h3 id="modal-title" class="font-bold mb-2 text-xl"></h3>
            <p id="modal-text" class="text-stone-400 text-sm mb-8 leading-relaxed"></p>
            <button onclick="closeModal()" class="w-full bg-stone-800 text-white py-3 rounded-2xl font-bold hover:bg-stone-900 transition-all shadow-md">ç¢ºå®š</button>
        </div>
    </div>
    
    <div id="add-contact-modal" class="fixed inset-0 bg-stone-900/40 z-[101] hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white rounded-3xl max-md w-full p-8 flex flex-col max-h-[85vh] shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-2xl text-stone-700">æ–°å¢è¯çµ¡çª—å£</h3>
                <button onclick="closeAddModal()" class="text-stone-300 hover:text-stone-600 text-2xl">&times;</button>
            </div>
            <div id="add-contact-form-container" class="overflow-y-auto flex-1 pr-3"></div>
            <div class="grid grid-cols-2 gap-4 mt-8">
                <button onclick="closeAddModal()" class="py-3 border-2 border-stone-100 rounded-2xl font-bold text-stone-400 hover:bg-stone-50 transition-all">å–æ¶ˆ</button>
                <button onclick="submitNewContact()" class="py-3 bg-orange-500 text-white rounded-2xl font-bold shadow-lg shadow-orange-100 hover:bg-orange-600 transition-all">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="delete-confirm-modal" class="fixed inset-0 bg-stone-900/40 z-[200] hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white rounded-3xl max-sm w-full p-8 text-center shadow-2xl border-b-4 border-red-500">
            <div class="text-red-500 text-5xl mb-4">âš ï¸</div>
            <h3 class="font-bold mb-3 text-red-600 text-xl">ç¢ºå®šåˆªé™¤æ­¤è¯çµ¡äººï¼Ÿ</h3>
            <div class="grid grid-cols-2 gap-4 mt-6">
                <button onclick="closeDeleteModal()" class="border-2 border-stone-100 p-3 rounded-2xl font-bold text-stone-400">è¿”å›</button>
                <button onclick="confirmDeleteAction()" class="bg-red-500 text-white p-3 rounded-2xl font-bold">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>
</body>
</html>
